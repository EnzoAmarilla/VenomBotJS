<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vincular WhatsApp - ReservaTurnos</title>
  <script src="/socket.io/socket.io.js"></script>

  <link rel="icon" href="https://reservaturnos.com/img/favicon.ico" type="image/x-icon">

  <!-- Tailwind -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">

  <!-- Navbar -->
  <nav class="bg-white shadow-md">
    <div class="max-w-6xl mx-auto px-4 flex justify-between items-center py-3">
      <a href="https://reservaturnos.com">
        <img src="https://reservaturnos.com/img/ReservaTurnosLogo.png" alt="Logo" class="w-12">
      </a>
      <a href="https://reservaturnos.com/dashboard" 
         class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition font-semibold">
        Volver al Dashboard
      </a>
    </div>
  </nav>

  <!-- Contenido principal -->
  <main class="flex-grow flex items-center justify-center">
    <div class="bg-white shadow-lg max-w-xl rounded-2xl p-10 text-center">
      <h1 class="text-2xl font-bold text-purple-700 mb-3">Escane√° el QR para vincular tu WhatsApp</h1>
      
      <div class="status-bar" id="statusBar" style="display: none;">
         <span id="statusText">üîÑ Iniciando...</span>
      </div>

      <div class="flex items-center justify-center mb-3">
          <i data-lucide="smartphone" class="w-4 h-4 md:w-5 md:h-5 mr-2"></i>
          <p id="qrStatus">Cargando QR...</p>
      </div>

      <div id="attemptCount" style="display:none; margin-top: 10px; font-weight: bold;"></div>

      <!-- Aqu√≠ va el QR generado din√°micamente por Venom Bot -->
      <div id="qrContainer" class="mb-6 flex justify-center">
        <!-- Tu script de QR lo renderiza ac√° -->
      </div>

      <p class="text-gray-600 mb-6">
        Abri tu WhatsApp en el celular ‚Üí <br>
        Ajustes <strong>&gt;</strong> Dispositivos vinculados <strong>&gt;</strong> Vincular un dispositivo.
      </p>

      <div class="chat-section" style="display: none;">
        <h3>üí¨ Mensajes en Tiempo Real</h3>
        <div class="messages-container" id="messagesContainer">
          <div class="info-card">
            <strong>ü§ñ Bot iniciado</strong><br>
            Los mensajes aparecer√°n aqu√≠ una vez que WhatsApp est√© conectado.
          </div>
        </div>

        <div class="controls">
          <h4>üì§ Enviar mensaje manual (opcional)</h4>
          <div class="input-group">
            <input type="text" id="phoneInput" placeholder="N√∫mero (ej: 5491123456789@c.us)" disabled>
            <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." disabled>
            <button id="sendButton" onclick="sendManualMessage()" disabled>Enviar</button>
          </div>
        </div>
      </div>

      <a href="https://reservaturnos.com/dashboard" 
         class="inline-block bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-medium">
        Volver al Dashboard
      </a>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-200 py-4 text-center text-sm text-gray-600">
    &copy; <script>document.write(new Date().getFullYear())</script> ReservaTurnos. Todos los derechos reservados.
  </footer>

  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      lucide.createIcons();
    });
  </script>
  
  <!-- Scripts de VenomBot (ejemplo) -->
  <script>
    const socket = io();

    // Obtener la ruta actual
    const path = window.location.pathname; // ej: "/123"
    
    // Dividir por "/" y tomar el √∫ltimo segmento
    const segments = path.split('/').filter(Boolean);
    const userId = segments[segments.length - 1];

    console.log("User ID capturado desde URL:", userId);

    const sessionId = userId; // üëâ c√°mbialo din√°micamente seg√∫n login

    let isConnected = false;

    // ====== Referencias al DOM ======
    const statusBar = document.getElementById('statusBar');
    const statusText = document.getElementById('statusText');
    const qrContainer = document.getElementById('qrContainer');
    const qrStatus = document.getElementById('qrStatus');
    const attemptCount = document.getElementById('attemptCount');
    const messagesContainer = document.getElementById('messagesContainer');
    const phoneInput = document.getElementById('phoneInput');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');

    // ================================
    // INICIAR SESI√ìN
    // ================================
    async function iniciarSesion() {
      try {
        const res = await fetch('/api/start-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId })
        });
        const data = await res.json();
        console.log("üöÄ Sesi√≥n iniciada:", data);
      } catch (err) {
        console.error("‚ùå Error al iniciar sesi√≥n:", err);
      }
    }
    iniciarSesion();

    // ================================
    // SOCKET.IO EVENTOS
    // ================================
    socket.on('qrCode', (data) => {
      if (data.sessionId !== sessionId) return;
      displayQRCode(data.qr, data.attempts);
    });

    socket.on('sessionStatus', (data) => {
      if (data.sessionId !== sessionId) return;
      updateStatus(data.status, data.isConnected);
    });

    socket.on('connected', (data) => {
      if (data.sessionId !== sessionId) return;
      isConnected = true;
      updateStatus('isLogged', true);
      hideQRCode();
      addSystemMessage('‚úÖ WhatsApp conectado exitosamente!', 'success');
      enableControls();
    });

    socket.on('messageReceived', (data) => {
      if (data.sessionId !== sessionId) return;
      addReceivedMessage(data);
    });

    socket.on('error', (data) => {
      if (data.sessionId !== sessionId) return;
      addSystemMessage(`‚ùå Error: ${data.message}`, 'error');
    });

    // ================================
    // FUNCIONES DE UI
    // ================================
    function displayQRCode(qrData, attempts) {
      qrContainer.innerHTML = `<img src="${qrData}" alt="C√≥digo QR" class="qr-code">`;
      qrStatus.textContent = `Esperando escaneo de QR`;
      attemptCount.textContent = `Intento: ${attempts}`;
      lucide.createIcons();
    }

    function hideQRCode() {
      qrContainer.innerHTML = `
        <div class="qr-placeholder">
          <div>
            <div style="font-size: 2em; margin-bottom: 10px;">‚úÖ</div>
            <div>WhatsApp conectado</div>
          </div>
        </div>
      `;
      qrStatus.textContent = `‚úÖ WhatsApp conectado exitosamente`;
      attemptCount.textContent = '';
    }

    function updateStatus(status, connected) {
      const statusMessages = {
        'isLogged': '‚úÖ WhatsApp conectado',
        'notLogged': '<i data-lucide="plus-circle" class="w-4 h-4 md:w-5 md:h-5"></i> Esperando escaneo de QR',
        'qrReadSuccess': '‚úÖ QR escaneado exitosamente',
        'qrReadFail': '‚ùå Error al leer QR',
        'browserClose': '‚ùå Navegador cerrado',
        'chatsAvailable': '‚úÖ Chats disponibles',
        'initBrowser': 'üåê Iniciando navegador...',
        'initWhatsapp': 'üì± Iniciando WhatsApp...',
        'successPageWhatsapp': '‚úÖ P√°gina de WhatsApp cargada'
      };

      const message = statusMessages[status] || `üîÑ ${status}`;
      statusText.textContent = message;

      if (connected) {
        statusBar.className = 'status-bar status-connected';
        isConnected = true;
      } else if (status.includes('error') || status.includes('fail') || status.includes('Close')) {
        statusBar.className = 'status-bar status-error';
        isConnected = false;
      } else {
        statusBar.className = 'status-bar';
        isConnected = false;
      }
    }

    function addSystemMessage(message, type = 'info') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `${type}-card`;
      messageDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong><br>${message}`;
      messagesContainer.appendChild(messageDiv);
      scrollToBottom();
    }

    function addReceivedMessage(data) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message message-received';
      messageDiv.innerHTML = `
        <strong>üì® Mensaje recibido</strong><br>
        <strong>De:</strong> ${data.from}<br>
        <strong>Mensaje:</strong> ${data.body}<br>
        <div class="message-time">${data.timestamp}</div>
      `;
      messagesContainer.appendChild(messageDiv);
      scrollToBottom();
    }

    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function enableControls() {
      phoneInput.disabled = false;
      messageInput.disabled = false;
      sendButton.disabled = false;
    }

    // ================================
    // ENVIAR MENSAJE MANUAL
    // ================================
    async function sendManualMessage() {
      const phone = phoneInput.value.trim();
      const message = messageInput.value.trim();

      if (!phone || !message) {
        alert('Por favor completa el n√∫mero y el mensaje');
        return;
      }

      if (!isConnected) {
        alert('WhatsApp no est√° conectado');
        return;
      }

      try {
        const response = await fetch('/api/send-message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, to: phone, message })
        });
        const result = await response.json();

        if (result.success) {
          addSystemMessage(`‚úÖ Mensaje enviado a ${phone}: ${message}`, 'success');
          messageInput.value = '';
        } else {
          addSystemMessage(`‚ùå Error al enviar mensaje: ${result.error}`, 'error');
        }
      } catch (error) {
        addSystemMessage(`‚ùå Error de red: ${error.message}`, 'error');
      }
    }
  </script>
</body>
</html>